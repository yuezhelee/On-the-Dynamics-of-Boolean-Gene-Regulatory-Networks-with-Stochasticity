% p = [ .1 .2 .3 .5; .4 .5 .6 .9]; x = [0 0 0 0; 0 0 0 1; 0 0 1 0; 0 0 1 1; 0 1 0 0; 0 1 0 1; 0 1 1 0; 0 1 1 1; 1 0 0 0; 1 0 0 1; 1 0 1 0; 1 0 1 1; 1 1 0 0; 1 1 0 1; 1 1 1 0; 1 1 1 1];f = 0.5*sign( rand( [16,4] ) - 0.5*ones(16,4) ) + 0.5 * ones(16,4); 
function F = Transition ( n, p, x , f )
P = zeros( 2^n, 2^n );

if n == 3
    p00 = Transition2( p(:, 2:n), x(1:2^(n-1), 2:n), f( 1:2^(n-1), 2:n ) );
else p00 = Transition( n-1 ,p(:, 2:n), x(1:2^(n-1), 2:n), f( 1:2^(n-1), 2:n ) );
end
p0 = [ p00; p00 ];
for i = 1:2^n
    if x(i,1) < f(i,1)
        P( i,1:2^(n-1) ) = ( 1 - p(1,1) )*p0(i,:);
        P( i,2^(n-1)+1 : 2^n ) = p(1,1) * p0(i,:);
    else if x(i,1) > f(i,1)
            P( i,1:2^(n-1) ) = p(2,1) * p0(i,:);
            P( i,2^(n-1)+1 : 2^n ) = ( 1-p(2,1) ) * p0(i,:);
        else % x(i,1) == f(i,1)
            if x(i,1) == 0
                P( i, 1:2^(n-1) ) = p0(i,:);
            else % x(i,1) == 1
                P( i,2^(n-1)+1 : 2^n ) = p0(i,:);
            end
        end
    end
end
F = P;